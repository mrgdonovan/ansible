---
  - name: restart machine
    shell: sleep 2 && shutdown -r now "Ansible updates triggered"
    async: 1
    poll: 0
    sudo: true
    ignore_errors: true

  - name: Send reboot email.
    local_action: mail host=smtp.co.ihc.com subject="Ansible System Reboot" body="{{ ansible_hostname }} Rebooting." from="ramon.gonzalez@imail.org" to="ramon.gonzalez@imail.org" charset=utf8

  - name: Send reboot hipchat message.
    hipchat: api="https://hipchat.co.ihc.com/v2/room/200/notification" token=V6o6hkFwteMCU7PycKFm9H8mQtZ1eYYfPbP2xJD0 room=notify color=red msg="{{ ansible_hostname }} Rebooting."

  - name: waiting for server to come back
    local_action: wait_for host={{ inventory_hostname }} state=started delay=30 timeout=120
    sudo: false

  - name: Send server up email.
    local_action: mail host=smtp.co.ihc.com subject="Ansible System Reboot Complete." body="{{ ansible_hostname }} Up. Ansible task complete." from="ramon.gonzalez@imail.org" to="ramon.gonzalez@imail.org" charset=utf8

  - name: Send server up hipchat message.
    hipchat: api="https://hipchat.co.ihc.com/v2/room/200/notification" token=V6o6hkFwteMCU7PycKFm9H8mQtZ1eYYfPbP2xJD0 room=notify color=green msg="{{ ansible_hostname }} Up."

